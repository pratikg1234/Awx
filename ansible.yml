---
- name: SQL Server Monitoring
   hosts: all
  gather_facts: no
  vars:
    mssql_ip: "20.102.105.60"
    mssql_username: "rajusql"
    mssql_password: "Raju@2002"

  tasks:
    - name: Check Database Space Utilization
      win_shell: |
        $query = "SELECT DB_NAME(database_id) AS DatabaseName, 
                         (size * 8) / 1024 AS SizeMB 
                  FROM sys.master_files 
                  WHERE type = 0;"
        Invoke-Sqlcmd -ServerInstance "{{ mssql_ip }}" -Username "{{ mssql_username }}" -Password "{{ mssql_password }}" -Query $query -TrustServerCertificate Yes
      register: db_space

    - name: Print Database Space Utilization
      debug:
        msg: "{{ db_space.stdout_lines }}"

    - name: Check Database Health
      win_shell: |
        $query = "SELECT name, state_desc, recovery_model_desc FROM sys.databases;"
        Invoke-Sqlcmd -ServerInstance "{{ mssql_ip }}" -Username "{{ mssql_username }}" -Password "{{ mssql_password }}" -Query $query -TrustServerCertificate Yes
      register: db_health

    - name: Print Database Health
      debug:
        msg: "{{ db_health.stdout_lines }}"

    - name: Check for Deadlocks
      win_shell: |
        $query = "SELECT request_session_id FROM sys.dm_tran_locks WHERE request_mode = 'X' GROUP BY request_session_id HAVING COUNT(*) > 1;"
        Invoke-Sqlcmd -ServerInstance "{{ mssql_ip }}" -Username "{{ mssql_username }}" -Password "{{ mssql_password }}" -Query $query -TrustServerCertificate Yes
      register: deadlocks

    - name: Print Deadlocks
      debug:
        msg: "{{ deadlocks.stdout_lines }}"

    - name: Check SQL Agent Job Activities
      win_shell: |
        $query = "SELECT job_id, name, enabled, last_run_outcome, last_run_date, last_run_time FROM msdb.dbo.sysjobs;"
        Invoke-Sqlcmd -ServerInstance "{{ mssql_ip }}" -Username "{{ mssql_username }}" -Password "{{ mssql_password }}" -Query $query -TrustServerCertificate Yes
      register: job_status

    - name: Print Job Activities
      debug:
        msg: "{{ job_status.stdout_lines }}"
